<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WASM Delta Compression Test Suite</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, sans-serif;
                background: #0f172a;
                color: #e2e8f0;
                padding: 20px;
                line-height: 1.6;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            h1 {
                color: #38bdf8;
                margin-bottom: 10px;
                font-size: 2em;
            }

            .subtitle {
                color: #94a3b8;
                margin-bottom: 30px;
                font-size: 1.1em;
            }

            .test-controls {
                background: #1e293b;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }

            button {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background 0.2s;
            }

            button:hover {
                background: #2563eb;
            }

            button:disabled {
                background: #475569;
                cursor: not-allowed;
            }

            .stats {
                background: #1e293b;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .stat-item {
                text-align: center;
            }

            .stat-value {
                font-size: 2em;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .stat-value.passed {
                color: #22c55e;
            }

            .stat-value.failed {
                color: #ef4444;
            }

            .stat-value.pending {
                color: #f59e0b;
            }

            .stat-label {
                color: #94a3b8;
                font-size: 0.9em;
            }

            .test-results {
                background: #1e293b;
                border-radius: 8px;
                padding: 20px;
                max-height: 600px;
                overflow-y: auto;
            }

            .test-category {
                margin-bottom: 25px;
            }

            .category-title {
                font-size: 1.2em;
                color: #38bdf8;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 2px solid #334155;
            }

            .test-item {
                padding: 12px;
                margin: 8px 0;
                border-radius: 6px;
                border-left: 4px solid;
                transition: background 0.2s;
            }

            .test-item:hover {
                background: #334155;
            }

            .test-item.passed {
                border-left-color: #22c55e;
                background: rgba(34, 197, 94, 0.1);
            }

            .test-item.failed {
                border-left-color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }

            .test-item.pending {
                border-left-color: #f59e0b;
                background: rgba(245, 158, 11, 0.1);
            }

            .test-name {
                font-weight: 500;
                margin-bottom: 5px;
            }

            .test-duration {
                color: #94a3b8;
                font-size: 0.85em;
            }

            .test-error {
                color: #fca5a5;
                font-size: 0.9em;
                margin-top: 5px;
                padding: 8px;
                background: rgba(239, 68, 68, 0.2);
                border-radius: 4px;
                font-family: "Courier New", monospace;
            }

            .progress-bar {
                width: 100%;
                height: 4px;
                background: #334155;
                border-radius: 2px;
                overflow: hidden;
                margin-bottom: 20px;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #3b82f6, #38bdf8);
                width: 0%;
                transition: width 0.3s;
            }

            .status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 500;
                margin-left: 10px;
            }

            .status-badge.running {
                background: rgba(245, 158, 11, 0.2);
                color: #fbbf24;
            }

            .status-badge.complete {
                background: rgba(34, 197, 94, 0.2);
                color: #22c55e;
            }

            .filter-buttons {
                display: flex;
                gap: 10px;
            }

            .filter-button {
                background: #334155;
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .filter-button.active {
                background: #3b82f6;
            }

            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #1e293b;
            }

            ::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üß™ WASM Delta Compression Test Suite</h1>
            <p class="subtitle">
                Comprehensive tests for sockudo-client WASM delta compression
                implementation
            </p>

            <div class="test-controls">
                <button id="runAllBtn" onclick="runAllTests()">
                    ‚ñ∂Ô∏è Run All Tests
                </button>
                <button id="clearBtn" onclick="clearResults()">
                    üóëÔ∏è Clear Results
                </button>
                <div class="filter-buttons">
                    <button
                        class="filter-button active"
                        onclick="filterTests('all')"
                    >
                        All
                    </button>
                    <button
                        class="filter-button"
                        onclick="filterTests('passed')"
                    >
                        ‚úÖ Passed
                    </button>
                    <button
                        class="filter-button"
                        onclick="filterTests('failed')"
                    >
                        ‚ùå Failed
                    </button>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value passed" id="passedCount">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value failed" id="failedCount">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value pending" id="pendingCount">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-item">
                    <div
                        class="stat-value"
                        id="totalTime"
                        style="color: #38bdf8"
                    >
                        0ms
                    </div>
                    <div class="stat-label">Total Time</div>
                </div>
                <div class="stat-item">
                    <div
                        class="stat-value"
                        id="successRate"
                        style="color: #f59e0b"
                    >
                        0%
                    </div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>

            <div class="test-results" id="testResults">
                <p style="color: #94a3b8; text-align: center">
                    Click "Run All Tests" to start testing...
                </p>
            </div>
        </div>

        <script type="module">
            import init, {
                WasmOptions,
                WasmDeltaOptions,
            } from "../pkg/sockudo_client.js";

            let testStats = {
                passed: 0,
                failed: 0,
                pending: 0,
                total: 0,
                totalTime: 0,
            };

            let allTests = [];
            let currentFilter = "all";

            // Initialize WASM
            await init();

            console.log("‚úÖ WASM initialized successfully");

            // Test definitions organized by category
            const testCategories = {
                "Delta Options - Basic": [
                    {
                        name: "Default delta options creation",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            assert(
                                opts.enabled === true,
                                "Should be enabled by default",
                            );
                            assert(
                                opts.debug === false,
                                "Debug should be false by default",
                            );
                            assert(
                                opts.max_messages_per_key === 10,
                                "Max messages should be 10",
                            );
                        },
                    },
                    {
                        name: "Enable/disable delta compression",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.enabled = true;
                            assert(opts.enabled === true, "Should be enabled");
                            opts.enabled = false;
                            assert(
                                opts.enabled === false,
                                "Should be disabled",
                            );
                        },
                    },
                    {
                        name: "Toggle debug mode",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.debug = true;
                            assert(
                                opts.debug === true,
                                "Debug should be enabled",
                            );
                            opts.debug = false;
                            assert(
                                opts.debug === false,
                                "Debug should be disabled",
                            );
                        },
                    },
                    {
                        name: "Set max messages per key",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.max_messages_per_key = 5;
                            assert(
                                opts.max_messages_per_key === 5,
                                "Should be 5",
                            );
                            opts.max_messages_per_key = 20;
                            assert(
                                opts.max_messages_per_key === 20,
                                "Should be 20",
                            );
                        },
                    },
                ],
                "Delta Options - Algorithms": [
                    {
                        name: "Set single algorithm (fossil)",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("fossil");
                            // Should not throw
                        },
                    },
                    {
                        name: "Set single algorithm (xdelta3)",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("xdelta3");
                            // Should not throw
                        },
                    },
                    {
                        name: "Set multiple algorithms",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("fossil,xdelta3");
                            opts.setAlgorithms("xdelta3,fossil");
                            // Should not throw
                        },
                    },
                    {
                        name: "Set algorithms with spaces",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("fossil , xdelta3");
                            opts.setAlgorithms(" fossil, xdelta3 ");
                            // Spaces should be trimmed
                        },
                    },
                    {
                        name: "Handle invalid algorithms gracefully",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("invalid");
                            opts.setAlgorithms("foo,bar");
                            opts.setAlgorithms("");
                            // Should fall back to defaults
                        },
                    },
                    {
                        name: "Handle mixed valid/invalid algorithms",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("fossil,invalid,xdelta3");
                            // Valid ones should be used
                        },
                    },
                    {
                        name: "Case insensitive algorithm names",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("FOSSIL,XDELTA3");
                            opts.setAlgorithms("Fossil,Xdelta3");
                            // Should work regardless of case
                        },
                    },
                ],
                "WasmOptions Integration": [
                    {
                        name: "Create WasmOptions with delta compression",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            opts.setDeltaCompression(deltaOpts);
                            // Should set successfully
                        },
                    },
                    {
                        name: "Enable delta compression convenience method",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            opts.enableDeltaCompression();
                            // Should enable with defaults
                        },
                    },
                    {
                        name: "Set disabled delta compression",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = false;
                            opts.setDeltaCompression(deltaOpts);
                            // Should accept disabled config
                        },
                    },
                    {
                        name: "Full configuration with all options",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            opts.cluster = "mt1";
                            opts.ws_host = "localhost";
                            opts.ws_port = 6001;
                            opts.use_tls = false;

                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.debug = true;
                            deltaOpts.max_messages_per_key = 15;
                            deltaOpts.setAlgorithms("fossil,xdelta3");

                            opts.setDeltaCompression(deltaOpts);
                            // Full config should work
                        },
                    },
                ],
                "Configuration Variations": [
                    {
                        name: "Fossil only configuration",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("fossil");
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Xdelta3 only configuration",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("xdelta3");
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Both algorithms enabled",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("fossil,xdelta3");
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Debug mode enabled",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.debug = true;
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Minimal cache size (1)",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.max_messages_per_key = 1;
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Large cache size (100)",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.max_messages_per_key = 100;
                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                ],
                "Edge Cases": [
                    {
                        name: "Zero max messages (edge case)",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.max_messages_per_key = 0;
                            assert(
                                opts.max_messages_per_key === 0,
                                "Should be 0",
                            );
                        },
                    },
                    {
                        name: "Very large max messages",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.max_messages_per_key = 2147483647; // Max i32
                            // Should handle large values
                        },
                    },
                    {
                        name: "Empty algorithm string",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("");
                            // Should fall back to defaults
                        },
                    },
                    {
                        name: "Only commas in algorithms",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms(",,,");
                            // Should handle gracefully
                        },
                    },
                    {
                        name: "Duplicate algorithms",
                        fn: () => {
                            const opts = new WasmDeltaOptions();
                            opts.setAlgorithms("fossil,fossil,xdelta3,xdelta3");
                            // Should deduplicate or handle gracefully
                        },
                    },
                    {
                        name: "Replace delta configuration",
                        fn: () => {
                            const opts = new WasmOptions("app-key");

                            const deltaOpts1 = new WasmDeltaOptions();
                            deltaOpts1.max_messages_per_key = 5;
                            opts.setDeltaCompression(deltaOpts1);

                            const deltaOpts2 = new WasmDeltaOptions();
                            deltaOpts2.max_messages_per_key = 20;
                            opts.setDeltaCompression(deltaOpts2);
                            // Should replace successfully
                        },
                    },
                ],
                "sockudo-js API Compatibility": [
                    {
                        name: "Default sockudo-js configuration",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("fossil,xdelta3");
                            deltaOpts.debug = false;
                            opts.setDeltaCompression(deltaOpts);
                            // Should match sockudo-js defaults
                        },
                    },
                    {
                        name: "Custom algorithm preference",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("xdelta3");
                            opts.setDeltaCompression(deltaOpts);
                            // Should match JS API
                        },
                    },
                    {
                        name: "Debug mode like sockudo-js",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.debug = true;
                            opts.setDeltaCompression(deltaOpts);
                            // Should match JS API
                        },
                    },
                    {
                        name: "Disabled like sockudo-js",
                        fn: () => {
                            const opts = new WasmOptions("app-key");
                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = false;
                            opts.setDeltaCompression(deltaOpts);
                            // Should match JS API
                        },
                    },
                ],
                "Real-world Scenarios": [
                    {
                        name: "Production configuration",
                        fn: () => {
                            const opts = new WasmOptions("prod-key");
                            opts.cluster = "mt1";
                            opts.use_tls = true;

                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("fossil,xdelta3");
                            deltaOpts.debug = false;
                            deltaOpts.max_messages_per_key = 10;

                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Development configuration",
                        fn: () => {
                            const opts = new WasmOptions("dev-key");
                            opts.ws_host = "localhost";
                            opts.ws_port = 6001;
                            opts.use_tls = false;

                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.debug = true;
                            deltaOpts.setAlgorithms("fossil");
                            deltaOpts.max_messages_per_key = 5;

                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                    {
                        name: "Minimal configuration",
                        fn: () => {
                            const opts = new WasmOptions("minimal-key");
                            opts.enableDeltaCompression();
                            // Simplest possible config
                        },
                    },
                    {
                        name: "High-throughput configuration",
                        fn: () => {
                            const opts = new WasmOptions("high-throughput-key");
                            opts.cluster = "mt1";

                            const deltaOpts = new WasmDeltaOptions();
                            deltaOpts.enabled = true;
                            deltaOpts.setAlgorithms("fossil,xdelta3");
                            deltaOpts.max_messages_per_key = 50;

                            opts.setDeltaCompression(deltaOpts);
                        },
                    },
                ],
            };

            function assert(condition, message) {
                if (!condition) {
                    throw new Error(message || "Assertion failed");
                }
            }

            async function runTest(test, category) {
                const startTime = performance.now();
                try {
                    await test.fn();
                    const duration = performance.now() - startTime;
                    return { passed: true, duration, error: null };
                } catch (error) {
                    const duration = performance.now() - startTime;
                    return { passed: false, duration, error: error.message };
                }
            }

            async function runAllTests() {
                const btn = document.getElementById("runAllBtn");
                btn.disabled = true;
                btn.textContent = "‚è≥ Running Tests...";

                testStats = {
                    passed: 0,
                    failed: 0,
                    pending: 0,
                    total: 0,
                    totalTime: 0,
                };
                allTests = [];

                const resultsDiv = document.getElementById("testResults");
                resultsDiv.innerHTML = "";

                let totalTests = 0;
                let completedTests = 0;

                // Count total tests
                for (const category in testCategories) {
                    totalTests += testCategories[category].length;
                }

                testStats.total = totalTests;

                for (const category in testCategories) {
                    const categoryDiv = document.createElement("div");
                    categoryDiv.className = "test-category";

                    const categoryTitle = document.createElement("div");
                    categoryTitle.className = "category-title";
                    categoryTitle.textContent = `${category} (${testCategories[category].length} tests)`;
                    categoryDiv.appendChild(categoryTitle);

                    for (const test of testCategories[category]) {
                        const result = await runTest(test, category);
                        completedTests++;

                        const testItem = document.createElement("div");
                        testItem.className = `test-item ${result.passed ? "passed" : "failed"}`;

                        const testName = document.createElement("div");
                        testName.className = "test-name";
                        testName.textContent = `${result.passed ? "‚úÖ" : "‚ùå"} ${test.name}`;
                        testItem.appendChild(testName);

                        const testDuration = document.createElement("div");
                        testDuration.className = "test-duration";
                        testDuration.textContent = `${result.duration.toFixed(2)}ms`;
                        testItem.appendChild(testDuration);

                        if (!result.passed) {
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "test-error";
                            errorDiv.textContent = result.error;
                            testItem.appendChild(errorDiv);
                            testStats.failed++;
                        } else {
                            testStats.passed++;
                        }

                        testStats.totalTime += result.duration;

                        categoryDiv.appendChild(testItem);

                        allTests.push({
                            category,
                            name: test.name,
                            passed: result.passed,
                            duration: result.duration,
                            error: result.error,
                            element: testItem,
                        });

                        // Update progress
                        const progress = (completedTests / totalTests) * 100;
                        document.getElementById("progressBar").style.width =
                            `${progress}%`;
                        updateStats();
                    }

                    resultsDiv.appendChild(categoryDiv);
                }

                btn.disabled = false;
                btn.textContent = "‚ñ∂Ô∏è Run All Tests";
                updateStats();
            }

            function updateStats() {
                document.getElementById("passedCount").textContent =
                    testStats.passed;
                document.getElementById("failedCount").textContent =
                    testStats.failed;
                document.getElementById("pendingCount").textContent = Math.max(
                    0,
                    testStats.total - testStats.passed - testStats.failed,
                );
                document.getElementById("totalTime").textContent =
                    `${testStats.totalTime.toFixed(0)}ms`;

                const successRate =
                    testStats.total > 0
                        ? ((testStats.passed / testStats.total) * 100).toFixed(
                              1,
                          )
                        : 0;
                document.getElementById("successRate").textContent =
                    `${successRate}%`;

                const rateElement = document.getElementById("successRate");
                if (successRate == 100) {
                    rateElement.style.color = "#22c55e";
                } else if (successRate >= 80) {
                    rateElement.style.color = "#f59e0b";
                } else {
                    rateElement.style.color = "#ef4444";
                }
            }

            function clearResults() {
                document.getElementById("testResults").innerHTML =
                    '<p style="color: #94a3b8; text-align: center;">Click "Run All Tests" to start testing...</p>';
                testStats = {
                    passed: 0,
                    failed: 0,
                    pending: 0,
                    total: 0,
                    totalTime: 0,
                };
                updateStats();
                document.getElementById("progressBar").style.width = "0%";
            }

            function filterTests(filter) {
                currentFilter = filter;

                // Update button states
                document.querySelectorAll(".filter-button").forEach((btn) => {
                    btn.classList.remove("active");
                });
                event.target.classList.add("active");

                // Filter test items
                allTests.forEach((test) => {
                    if (
                        filter === "all" ||
                        (filter === "passed" && test.passed) ||
                        (filter === "failed" && !test.passed)
                    ) {
                        test.element.style.display = "block";
                    } else {
                        test.element.style.display = "none";
                    }
                });
            }

            // Make functions global
            window.runAllTests = runAllTests;
            window.clearResults = clearResults;
            window.filterTests = filterTests;

            console.log("‚úÖ Test suite ready!");
        </script>
    </body>
</html>
